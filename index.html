<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <title>Bazar Pahlawan XI TKJ 2</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    body { background: #fff8e1; font-family: 'Segoe UI', sans-serif; }
    .menu-card { transition: 0.3s; cursor: pointer; }
    .menu-card:hover { transform: scale(1.05); box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
    .img-menu { height: 180px; object-fit: cover; }
    .d-none { display: none !important; }
    #notifSound { display: none; }
    .total-card { font-size: 1.5rem; }
    .status-dimasak { background-color: #fff3cd !important; }
    .status-siap { background-color: #d4edda !important; }
  </style>
</head>
<body>
  <div class="bg-danger text-white py-3 sticky-top shadow">
    <div class="container d-flex justify-content-between align-items-center">
      <h3 class="mb-0">üáÆüá© BAZZAR XI TKJ 2 CUT MEUTIA üáÆüá©</h3>
      <button class="btn btn-warning rounded-circle shadow position-relative" onclick="showPage('keranjangPage')">
        <i class="bi bi-cart-fill"></i>
        <span id="cartCount" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-dark">0</span>
      </button>
    </div>
  </div>
  <div class="container mt-4" id="menuPage">
    <div class="row row-cols-2 row-cols-md-4 g-4" id="menuContainer">
      <!-- Menu akan di-load otomatis di sini -->
    </div>
  </div>
  <div class="container mt-5 d-none" id="keranjangPage">
    <h3>Keranjang Belanja <span id="cartTotal" class="text-danger fw-bold">Rp 0</span></h3>
    <div id="cartItems"></div>
    <button class="btn btn-success w-100 mt-3 fw-bold" onclick="showPage('checkoutPage')" id="checkoutBtn" disabled>Lanjut Checkout</button>
    <button class="btn btn-secondary w-100 mt-2" onclick="showPage('menuPage')">Tambah Menu Lagi</button>
  </div>
  <div class="container mt-5 d-none" id="checkoutPage">
    <div class="card shadow">
      <div class="card-header bg-success text-white text-center"><h4>Checkout Pesanan</h4></div>
      <div class="card-body">
        <div class="mb-3"><label class="form-label fw-bold">Nama Pemesan *</label><input type="text" id="namaCheckout" class="form-control"></div>
        <div class="mb-3"><label class="form-label fw-bold">Nomor HP *</label><input type="text" id="hpCheckout" class="form-control" placeholder="628123456789"></div>
        <div class="mb-3"><label class="form-label fw-bold">Metode Pembayaran *</label>
          <select id="pembayaran" class="form-select">
            <option value="">-- Pilih --</option>
            <option value="Cash di Kasir">Cash di Kasir</option>
            <option value="QRIS">QRIS (scan di kasir)</option>
          </select>
        </div>
        <div class="mb-3"><label class="form-label fw-bold">Catatan</label><textarea id="catatanCheckout" class="form-control" rows="2"></textarea></div>
        <button class="btn btn-primary btn-lg w-100 fw-bold" onclick="kirimPesanan()">KIRIM PESANAN</button>
      </div>
    </div>
    <p class="text-center text-success fw-bold mt-3">Pesanan masuk real-time ke kasir!</p>
  </div>
  <div class="container mt-5 d-none" id="loginPage">
    <div class="card mx-auto shadow" style="max-width:400px;">
      <div class="card-header bg-dark text-white text-center"><h4>üîê Login Admin</h4></div>
      <div class="card-body">
        <input type="password" id="adminPass" class="form-control mb-3" placeholder="Password">
        <button class="btn btn-primary w-100" onclick="loginAdmin()">Login</button>
        <small class="text-muted d-block text-center mt-2">Default: admintkj</small>
        <button class="btn btn-sm btn-link text-muted mt-2" onclick="document.getElementById('adminPass').value='admintkj'; loginAdmin();">ü§´ Auto Fill + Login</button>
      </div>
    </div>
  </div>
  <div class="container mt-4 d-none" id="adminPage">
    <h2 class="text-danger fw-bold">üìä Dashboard Admin
      <button onclick="logout()" class="btn btn-danger btn-sm float-end">Logout</button>
      <button onclick="clearAllPesanan()" class="btn btn-warning btn-sm float-end me-2">Hapus Semua Pesanan</button>
      <button onclick="clearHistory()" class="btn btn-dark btn-sm float-end me-2">Hapus History</button>
      <button onclick="tambahMenuBaru()" class="btn btn-success btn-sm float-end me-2">+ Menu Baru</button>
    </h2>
    
    <div class="row mb-4">
      <div class="col-md-4">
        <div class="card text-white bg-success total-card">
          <div class="card-body text-center">
            <h4>Total Pendapatan Hari Ini</h4>
            <h3 id="totalPendapatan">Rp 0</h3>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card text-white bg-primary total-card">
          <div class="card-body text-center">
            <h4>Laba Kotor Hari Ini</h4>
            <h3 id="labaKotor">Rp 0</h3>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card text-white bg-info total-card">
          <div class="card-body text-center">
            <h4>Laba Bersih Hari Ini</h4>
            <h3 id="labaBersih">Rp 0</h3>
          </div>
        </div>
      </div>
    </div>

    <div class="card shadow mb-4">
      <div class="card-header bg-dark text-white"><h5>üí∏ Input Modal Hari Ini (biaya bahan, listrik, dll)</h5></div>
      <div class="card-body">
        <div class="input-group">
          <span class="input-group-text">Rp</span>
          <input type="number" id="modalHariIni" class="form-control form-control-lg" placeholder="0" value="0">
          <button class="btn btn-success" onclick="simpanModal()">Simpan Modal</button>
        </div>
        <small class="text-muted">Modal hari ini tersimpan otomatis di Firebase (real-time semua device)</small>
      </div>
    </div>

    <ul class="nav nav-tabs mb-4" id="adminTabs">
      <li class="nav-item">
        <a class="nav-link active" href="#" onclick="switchTab('pending')">Pesanan Masuk</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="#" onclick="switchTab('history')">History Transaksi</a>
      </li>
    </ul>
    <div id="pendingTab">
      <div class="table-responsive mb-4">
        <table class="table table-striped" id="ordersTable">
          <thead class="table-dark">
            <tr><th>No</th><th>Status</th><th>Nama</th><th>HP</th><th>Pembayaran</th><th>Items</th><th>Total</th><th>Catatan</th><th>Waktu</th><th>Aksi</th></tr>
          </thead>
          <tbody><tr><td colspan="10" class="text-center">Loading pesanan...</td></tr></tbody>
        </table>
      </div>
    </div>
    <div id="historyTab" class="d-none">
      <div class="table-responsive mb-4">
        <table class="table table-striped" id="historyTable">
          <thead class="table-success">
            <tr><th>No</th><th>Nama</th><th>HP</th><th>Pembayaran</th><th>Items</th><th>Total</th><th>Catatan</th><th>Waktu Masuk</th><th>Waktu Selesai</th><th>Aksi</th></tr>
          </thead>
          <tbody><tr><td colspan="10" class="text-center">Loading history...</td></tr></tbody>
        </table>
      </div>
    </div>

    <h4 class="mt-5">üßÆ Kalkulator Kembalian (Cash)</h4>
    <div class="card shadow mb-4">
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label fw-bold">Total Tagihan</label>
            <input type="number" id="tagihanCalc" class="form-control form-control-lg text-danger fw-bold" placeholder="0" readonly>
          </div>
          <div class="col-md-4">
            <label class="form-label fw-bold">Dibayar Customer</label>
            <input type="number" id="dibayarCalc" class="form-control form-control-lg text-primary fw-bold" placeholder="0" oninput="hitungKembalian()">
          </div>
          <div class="col-md-4">
            <label class="form-label fw-bold">Kembalian</label>
            <input type="number" id="kembalianCalc" class="form-control form-control-lg text-success fw-bold" placeholder="0" readonly>
          </div>
        </div>
        <div class="mt-3 text-center">
          <button class="btn btn-outline-secondary btn-sm" onclick="document.getElementById('dibayarCalc').value = document.getElementById('tagihanCalc').value; hitungKembalian();">Pas</button>
          <button class="btn btn-outline-secondary btn-sm" onclick="document.getElementById('dibayarCalc').value = Math.ceil(parseInt(document.getElementById('tagihanCalc').value || 0)/5000)*5000; hitungKembalian();">Pembulatan</button>
        </div>
      </div>
    </div>

    <h4>MENU TERKINI ‚¨áÔ∏è‚¨áÔ∏è</h4>
    <div id="menuAdminContainer" class="row row-cols-2 row-cols-md-4 g-4">Loading...</div>
  </div>
  <footer class="fixed-bottom bg-dark text-white text-center py-2">
    <small>
      <a href="#" onclick="showPage('loginPage');return false;" class="text-white" id="adminBtn">‚öôÔ∏è Admin</a>
    </small>
  </footer>
  <audio id="notifSound" preload="auto">
    <source src="https://cdn.jsdelivr.net/gh/fawmi/ivt-notif@master/ding.mp3" type="audio/mpeg">
  </audio>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBBvqvXsOtl588TEIzgs6mN9D6NxizSRZo",
      authDomain: "warung-tkj-bazar.firebaseapp.com",
      databaseURL: "https://warung-tkj-bazar-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "warung-tkj-bazar",
      storageBucket: "warung-tkj-bazar.firebasestorage.app",
      messagingSenderId: "150690959041",
      appId: "1:150690959041:web:cc6aa147cf122df3694e40",
      measurementId: "G-80L8N95QFL"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const menuRef = db.ref('menu');
    const pesananRef = db.ref('pesanan');
    const historyRef = db.ref('history');
    const modalRef = db.ref('modalHariIni');
    let cart = JSON.parse(localStorage.getItem('cartWarung') || '[]');
    let menu = [];
    let pesanan = {};
    let history = {};
    let totalPendapatanHariIni = 0;
    let modalHariIni = 0;

    const defaultMenu = [
      {nama: "Nasi Goreng Spesial", harga: 25000, img: "https://images.unsplash.com/photo-1603133874008-61ba9ed3c9e8?w=400"},
      {nama: "Mie Ayam Bakso", harga: 22000, img: "https://images.unsplash.com/photo-1621996346565-e3dbc44ae2d2?w=400"},
      {nama: "Soto Ayam", harga: 20000, img: "https://images.unsplash.com/photo-1546833999-b3596140c1be?w=400"},
      {nama: "Ayam Geprek", harga: 28000, img: "https://images.unsplash.com/photo-1562967914-608f82629710?w=400"},
      {nama: "Bakso Urat Jumbo", harga: 30000, img: "https://images.unsplash.com/photo-1604902396938-18b007d5895c?w=400"},
      {nama: "Gado-Gado", harga: 18000, img: "https://images.unsplash.com/photo-1511690078903-71dc5a3e8ff5?w=400"},
      {nama: "Es Teh Manis", harga: 5000, img: "https://images.unsplash.com/photo-1623278526302-7e89f05a23be?w=400"},
      {nama: "Kopi Hitam", harga: 8000, img: "https://images.unsplash.com/photo-1517251567592-6a846f655713?w=400"}
    ];

    function renderDefaultMenu() {
      const cont = document.getElementById('menuContainer');
      cont.innerHTML = '';
      defaultMenu.forEach((m) => {
        cont.innerHTML += `<div class="col">
          <div class="card menu-card h-100 text-center border-0 shadow" onclick="addToCart('${m.nama.replace(/'/g, "\\'")}', ${m.harga}, '${m.img}')">
            <img src="${m.img}" class="card-img-top img-menu rounded-top" alt="${m.nama}" onerror="this.src='https://via.placeholder.com/400x180?text=No+Image';">
            <div class="card-body">
              <h6 class="card-title fw-bold">${m.nama}</h6>
              <p class="text-danger fw-bold">Rp ${m.harga.toLocaleString('id-ID')}</p>
            </div>
          </div>
        </div>`;
      });
    }

    menuRef.on('value', (snap) => {
      const data = snap.val();
      if (data && Array.isArray(data) && data.length > 0) {
        menu = data;
      } else {
        menu = defaultMenu;
      }
      renderMenu();
      if (document.getElementById('adminPage') && !document.getElementById('adminPage').classList.contains('d-none')) renderMenuAdmin();
    }, (error) => {
      console.error("Firebase error:", error);
      menu = defaultMenu;
      renderMenu();
      alert('Koneksi Firebase bermasalah, menggunakan menu default.');
    });

    setTimeout(() => {
      if (menu.length === 0) {
        menu = defaultMenu;
        renderMenu();
      }
    }, 5000);

    modalRef.on('value', (snap) => {
      modalHariIni = parseInt(snap.val()) || 0;
      document.getElementById('modalHariIni').value = modalHariIni;
      hitungLaba();
    });

    historyRef.on('value', (snap) => {
      history = snap.val() || {};
      if (document.getElementById('adminPage') && !document.getElementById('adminPage').classList.contains('d-none')) {
        loadHistory();
        hitungPendapatanHariIni();
        hitungLaba();
      }
    });

    pesananRef.on('child_added', (snap) => {
      pesanan[snap.key] = snap.val();
      if (document.getElementById('adminPage') && !document.getElementById('adminPage').classList.contains('d-none')) {
        loadPesanan();
        document.getElementById('notifSound').play().catch(() => {});
      }
    });
    pesananRef.on('child_changed', (snap) => {
      pesanan[snap.key] = snap.val();
      if (document.getElementById('adminPage') && !document.getElementById('adminPage').classList.contains('d-none')) loadPesanan();
    });
    pesananRef.on('child_removed', (snap) => {
      delete pesanan[snap.key];
      if (document.getElementById('adminPage') && !document.getElementById('adminPage').classList.contains('d-none')) loadPesanan();
    });

    function simpanModal() {
      const val = parseInt(document.getElementById('modalHariIni').value) || 0;
      modalRef.set(val);
      alert('Modal hari ini disimpan: Rp ' + val.toLocaleString('id-ID'));
    }

    function hitungPendapatanHariIni() {
      const today = new Date().toLocaleDateString('id-ID');
      totalPendapatanHariIni = 0;
      Object.values(history).forEach(h => {
        if (h.waktuSelesai && h.waktuSelesai.includes(today)) {
          totalPendapatanHariIni += parseInt(h.total) || 0;
        }
      });
      document.getElementById('totalPendapatan').textContent = 'Rp ' + totalPendapatanHariIni.toLocaleString('id-ID');
    }

    function hitungLaba() {
      const labaKotor = totalPendapatanHariIni;
      const labaBersih = labaKotor - modalHariIni;
      document.getElementById('labaKotor').textContent = 'Rp ' + labaKotor.toLocaleString('id-ID');
      document.getElementById('labaBersih').textContent = 'Rp ' + (labaBersih >= 0 ? labaBersih.toLocaleString('id-ID') : '0');
    }

    function hitungKembalian() {
      const tagihan = parseInt(document.getElementById('tagihanCalc').value) || 0;
      const dibayar = parseInt(document.getElementById('dibayarCalc').value) || 0;
      const kembalian = dibayar - tagihan;
      document.getElementById('kembalianCalc').value = kembalian >= 0 ? kembalian : 0;
    }

    function setTagihan(total) {
      document.getElementById('tagihanCalc').value = total;
      document.getElementById('dibayarCalc').value = '';
      document.getElementById('kembalianCalc').value = '0';
      hitungKembalian();
    }

    function switchTab(tab) {
      document.querySelectorAll('#pendingTab, #historyTab').forEach(el => el.classList.add('d-none'));
      document.getElementById(tab + 'Tab').classList.remove('d-none');
      document.querySelectorAll('#adminTabs .nav-link').forEach(a => a.classList.remove('active'));
      event.target.classList.add('active');
      if (tab === 'pending') loadPesanan();
      if (tab === 'history') loadHistory();
    }

    function showPage(id) {
      document.querySelectorAll('#menuPage, #keranjangPage, #checkoutPage, #loginPage, #adminPage').forEach(el => el.classList.add('d-none'));
      document.getElementById(id).classList.remove('d-none');
      if (id === 'menuPage') renderMenu();
      if (id === 'keranjangPage') renderCart();
      if (id === 'adminPage') { 
        switchTab('pending');
        loadPesanan(); 
        loadHistory();
        hitungPendapatanHariIni();
        hitungLaba();
        renderMenuAdmin(); 
      }
    }

    function renderMenu() {
      const cont = document.getElementById('menuContainer');
      cont.innerHTML = '';
      menu.forEach((m) => {
        cont.innerHTML += `<div class="col">
          <div class="card menu-card h-100 text-center border-0 shadow" onclick="addToCart('${m.nama.replace(/'/g, "\\'")}', ${m.harga}, '${m.img}')">
            <img src="${m.img}" class="card-img-top img-menu rounded-top" alt="${m.nama}" onerror="this.src='https://via.placeholder.com/400x180?text=No+Image';">
            <div class="card-body">
              <h6 class="card-title fw-bold">${m.nama}</h6>
              <p class="text-danger fw-bold">Rp ${m.harga.toLocaleString('id-ID')}</p>
            </div>
          </div>
        </div>`;
      });
    }

    function addToCart(nama, harga, img) {
      const ada = cart.find(i => i.nama === nama);
      if (ada) ada.qty += 1;
      else cart.push({nama, harga, img, qty: 1});
      localStorage.setItem('cartWarung', JSON.stringify(cart));
      updateCartCount();
      alert(nama + ' ditambahkan ke keranjang!');
    }

    function updateCartCount() {
      const totalQty = cart.reduce((s, i) => s + i.qty, 0);
      document.getElementById('cartCount').textContent = totalQty || '0';
    }

    function renderCart() {
      const itemsDiv = document.getElementById('cartItems');
      let html = '';
      let total = 0;
      if (cart.length === 0) {
        html = '<p class="text-center text-muted">Keranjang kosong</p>';
        document.getElementById('checkoutBtn').disabled = true;
      } else {
        cart.forEach((item, idx) => {
          const sub = item.harga * item.qty;
          total += sub;
          html += `<div class="card mb-2">
            <div class="row g-0 align-items-center">
              <div class="col-3"><img src="${item.img}" class="img-fluid rounded-start" style="height:80px;object-fit:cover;" onerror="this.src='https://via.placeholder.com/80?text=Img';"></div>
              <div class="col-9">
                <div class="card-body py-2">
                  <h6 class="mb-0">${item.nama}</h6>
                  <p class="mb-0">Rp ${item.harga.toLocaleString('id-ID')} √ó ${item.qty} = Rp ${sub.toLocaleString('id-ID')}</p>
                  <button class="btn btn-sm btn-outline-primary" onclick="changeQty(${idx},1)">+</button>
                  <button class="btn btn-sm btn-outline-danger" onclick="changeQty(${idx},-1)">-</button>
                  <button class="btn btn-sm btn-danger" onclick="removeItem(${idx})">Hapus</button>
                </div>
              </div>
            </div>
          </div>`;
        });
        document.getElementById('checkoutBtn').disabled = false;
      }
      itemsDiv.innerHTML = html;
      document.getElementById('cartTotal').textContent = 'Rp ' + total.toLocaleString('id-ID');
    }

    function changeQty(idx, delta) {
      cart[idx].qty += delta;
      if (cart[idx].qty <= 0) cart.splice(idx, 1);
      localStorage.setItem('cartWarung', JSON.stringify(cart));
      renderCart();
      updateCartCount();
    }

    function removeItem(idx) {
      cart.splice(idx, 1);
      localStorage.setItem('cartWarung', JSON.stringify(cart));
      renderCart();
      updateCartCount();
    }

    function kirimPesanan() {
      const nama = document.getElementById('namaCheckout').value.trim();
      const hp = document.getElementById('hpCheckout').value.trim();
      const pembayaran = document.getElementById('pembayaran').value;
      const catatan = document.getElementById('catatanCheckout').value.trim() || '-';
      if (!nama || !hp || !pembayaran) return alert('Isi semua field wajib!');
      let total = 0;
      const items = cart.map(i => {
        total += i.harga * i.qty;
        return `${i.nama} √ó ${i.qty}`;
      }).join(', ');
      const pesananBaru = {
        nama, hp, pembayaran, items, total, catatan,
        waktu: new Date().toLocaleString('id-ID'),
        status: 'baru'
      };
      pesananRef.push(pesananBaru);
      alert('Pesanan terkirim! Kasir langsung terima üî•');
      cart = [];
      localStorage.setItem('cartWarung', JSON.stringify(cart));
      updateCartCount();
      showPage('menuPage');
    }

    function loginAdmin() {
      if (document.getElementById('adminPass').value === 'admintkj') {
        sessionStorage.setItem('adminOK', 'ya');
        showPage('adminPage');
      } else {
        alert('Password salah! Coba lagi atau klik tombol ü§´ Auto Fill + Login');
      }
    }

    function logout() {
      sessionStorage.removeItem('adminOK');
      showPage('menuPage');
    }

    function loadPesanan() {
      if (sessionStorage.getItem('adminOK') !== 'ya') return showPage('loginPage');
      const tbody = document.querySelector('#ordersTable tbody');
      tbody.innerHTML = '';
      if (Object.keys(pesanan).length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" class="text-center">Belum ada pesanan</td></tr>';
        return;
      }
      Object.keys(pesanan).reverse().forEach((key, i) => {
        const p = pesanan[key];
        const rowClass = p.status === 'dimasak' ? 'status-dimasak' : (p.status === 'siap' ? 'status-siap' : '');
        const statusText = p.status === 'dimasak' ? 'Sedang Dimasak' : (p.status === 'siap' ? 'Siap Diambil' : 'Pesanan Baru');
        const statusBadge = p.status === 'dimasak' ? 'warning' : (p.status === 'siap' ? 'success' : 'secondary');
        tbody.innerHTML += `<tr class="${rowClass}">
          <td>${i+1}</td>
          <td><span class="badge bg-${statusBadge}">${statusText}</span></td>
          <td>${p.nama}</td>
          <td>${p.hp}</td>
          <td><span class="badge bg-${p.pembayaran.includes('Cash') ? 'success' : 'primary'}">${p.pembayaran}</span></td>
          <td>${p.items}</td>
          <td>Rp ${p.total.toLocaleString('id-ID')}</td>
          <td>${p.catatan}</td>
          <td>${p.waktu}</td>
          <td>
            <button class="btn btn-sm btn-info me-1" onclick="setTagihan(${p.total})" title="Hitung Kembalian">üí∞</button>
            ${p.status !== 'dimasak' ? `<button class="btn btn-sm btn-warning me-1" onclick="setStatus('${key}', 'dimasak')">üç≥ Dimasak</button>` : ''}
            ${p.status !== 'siap' ? `<button class="btn btn-sm btn-primary me-1" onclick="setStatus('${key}', 'siap')">‚úîÔ∏è Siap</button>` : ''}
            <button class="btn btn-sm btn-success" onclick="selesaiPesanan('${key}')">SELESAI</button>
          </td>
        </tr>`;
      });
    }

    function setStatus(key, newStatus) {
      pesananRef.child(key).update({status: newStatus});
    }

    function selesaiPesanan(key) {
      if (confirm('Tandai selesai? Pesanan akan masuk ke History')) {
        const pesananSelesai = pesanan[key];
        pesananSelesai.waktuSelesai = new Date().toLocaleString('id-ID');
        historyRef.push(pesananSelesai);
        pesananRef.child(key).remove();
      }
    }

    function clearAllPesanan() {
      if (confirm('Hapus SEMUA pesanan masuk?')) pesananRef.set(null);
    }

    function clearHistory() {
      if (confirm('Hapus SEMUA history transaksi?')) historyRef.set(null);
      modalRef.set(0);
    }

    function hapusHistoryTerpilih(key, totalH) {
      if (confirm('Hapus history ini? Total Rp ' + totalH.toLocaleString('id-ID') + ' akan dikurangi dari pendapatan hari ini.')) {
        historyRef.child(key).remove();
        // Otomatis hitung ulang setelah remove (karena on('value') akan trigger)
      }
    }

    function loadHistory() {
      const tbody = document.querySelector('#historyTable tbody');
      tbody.innerHTML = '';
      if (Object.keys(history).length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" class="text-center">Belum ada history transaksi</td></tr>';
        return;
      }
      const today = new Date().toLocaleDateString('id-ID');
      Object.keys(history).reverse().forEach((key, i) => {
        const h = history[key];
        const totalH = parseInt(h.total) || 0;
        tbody.innerHTML += `<tr>
          <td>${i+1}</td>
          <td>${h.nama}</td>
          <td>${h.hp}</td>
          <td><span class="badge bg-${h.pembayaran.includes('Cash') ? 'success' : 'primary'}">${h.pembayaran}</span></td>
          <td>${h.items}</td>
          <td>Rp ${totalH.toLocaleString('id-ID')}</td>
          <td>${h.catatan}</td>
          <td>${h.waktu}</td>
          <td>${h.waktuSelesai || '-'}</td>
          <td><button class="btn btn-sm btn-danger" onclick="hapusHistoryTerpilih('${key}', ${totalH})">üóëÔ∏è Hapus</button></td>
        </tr>`;
      });
    }

    function renderMenuAdmin() {
      const cont = document.getElementById('menuAdminContainer');
      cont.innerHTML = '';
      menu.forEach((m, i) => {
        cont.innerHTML += `<div class="col">
          <div class="card h-100">
            <img src="${m.img}" class="card-img-top" style="height:150px;object-fit:cover;" onerror="this.src='https://via.placeholder.com/400';">
            <div class="card-body">
              <input type="text" class="form-control mb-2" value="${m.nama}" onchange="updateMenu(${i}, 'nama', this.value)">
              <input type="number" class="form-control mb-2" value="${m.harga}" onchange="updateMenu(${i}, 'harga', parseInt(this.value))">
              <input type="text" class="form-control mb-2" value="${m.img}" onchange="updateMenu(${i}, 'img', this.value)">
              <button class="btn btn-danger btn-sm w-100" onclick="hapusMenu(${i})">Hapus</button>
            </div>
          </div>
        </div>`;
      });
    }

    function updateMenu(i, field, value) {
      menu[i][field] = field === 'harga' ? value : value;
      menuRef.set(menu);
    }

    function hapusMenu(i) {
      if (confirm('Hapus menu ini?')) {
        menu.splice(i, 1);
        menuRef.set(menu);
      }
    }

    function tambahMenuBaru() {
      const nama = prompt('Nama menu baru:');
      const harga ÿ™ŸÖÿ±€åŸÜ = parseInt(prompt('Harga:'));
      const img = prompt('Link gambar:') || 'https://via.placeholder.com/400';
      if (nama && harga) {
        menu.push({nama, harga, img});
        menuRef.set(menu);
      }
    }

    // INIT
    renderDefaultMenu();
    updateCartCount();
    showPage('menuPage');
  </script>
</body>
</html>
