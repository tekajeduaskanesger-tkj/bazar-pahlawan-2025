<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <title>Warung Makan Enak - Pesan Online</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    body { background: #fff8e1; font-family: 'Segoe UI', sans-serif; }
    .menu-card { transition: 0.3s; cursor: pointer; }
    .menu-card:hover { transform: scale(1.05); box-shadow: 0 10‰∏ñÁöÑ20px rgba(0,0,0,0.2); }
    .img-menu { height: 180px; object-fit: cover; }
    .d-none { display: none !important; }
    @media (max-width: 767px) { #adminBtn { display: inline-block !important; } }
    #notifSound { display: none; }
  </style>
  <script src="https://www.gstatic.com/firebasejs/10.14.1 firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>
</head>
<body>
  <!-- HEADER, MENU, KERANJANG, CHECKOUT, LOGIN, ADMIN SAMA SEPERTI SEBELUMNYA -->

  <div class="bg-danger text-white py-3 sticky-top shadow">
    <div class="container d-flex justify-content-between align-items-center">
      <h3 class="mb-0">üçî WARUNG MAKAN ENAK</h3>
      <button class="btn btn-warning rounded-circle shadow position-relative" onclick="showPage('keranjangPage')">
        <i class="bi bi-cart-fill"></i> <span id="cartCount" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">0</span>
      </button>
    </div>
  mirip seperti kode sebelumnya, tapi script di bawah yang baru
  </div>

  <!-- Halaman-halaman lain copy dari kode lama-mu, atau pakai ini full script fix di bawah -->

  <audio id="notifSound" src="https://cdn.jsdelivr.net/gh/tekajeduaskanesger-tkj/bazar-pahlawan-2025@master/ding.mp3"></audio>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBBvqvXsOtl588TEIzgs6mN9D6NxizSRZo",
      authDomain: "warung-tkj-bazar.firebaseapp.com",
      databaseURL: "https://warung-tkj-bazar-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "warung-tkj-bazar",
      storageBucket: "warung-tkj-bazar.firebasestorage.app",
      messagingSenderId: "150690959041",
      appId: "1:150690959041:web:cc6aa147cf122df3694e40",
      measurementId: "G-80L8N95QFL"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const menuRef = db.ref('menu');
    const pesananRef = db.ref('pesanan');

    let cart = JSON.parse(localStorage.getItem('cartWarung') || '[]');
    let menu = [];
    let pesanan = {}; // OBJECT, bukan array (fix key Firebase)

    // Load menu (sekali + update kalau ada change)
    menuRef.on('value', snap => {
      menu = snap.val() || [];
      if (menu.length === 0) {
        // default menu
        menu = [ /* menu default sama */ ];
        menuRef.set(menu);
      }
      renderMenu();
      if (!document.getElementById('adminPage').classList.contains('d-none')) renderMenuAdmin();
    });

    // REAL-TIME PESANAN FIX NO LOOP!
    pesananRef.on('child_added', snap => {
      pesanan[snap.key] = snap.val();
      if (!document.getElementById('adminPage').classList.contains('d-none')) {
        loadPesanan();
        document.getElementById('notifSound').play().catch(() => {});
      }
    });

    pesananRef.on('child_removed', snap => {
      delete pesanan[snap.key];
      if (!document.getElementById('adminPage').classList.contains('d-none')) loadPesanan();
    });

    pesananRef.on('child_changed', snap => { // kalau ada edit nanti
      pesanan[snap.key] = snap.val();
      if (!document.getElementById('adminPage').classList.contains('d-none')) loadPesanan();
    });

    // Hapus 'value' listener yang bikin loop!

    // loadPesanan FIX pakai Object.keys(pesanan).reverse()
    function loadPesanan() {
      if (sessionStorage.getItem('adminOK') !== 'ya') return showPage('loginPage');
      const tbody = document.querySelector('#ordersTable tbody');
      tbody.innerHTML = '';
      if (Object.keys(pesanan).length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center">Belum ada pesanan</td></tr>';
        return;
      }
      Object.keys(pesanan).reverse().forEach((key, idx) => {
        const p = pesanan[key];
        tbody.innerHTML += `<tr>
          <td>${idx + 1}</td>
          <td>${p.nama}</td>
          <td>${p.hp}</td>
          <td><span class="badge bg-${p.pembayaran === 'Cash di Kasir' ? 'success' : 'primary'}">${p.pembayaran}</span></td>
          <td>${p.items}</td>
          <td>Rp ${p.total.toLocaleString('id-ID')}</td>
          <td>${p.waktu}</td>
          <td><button class="btn btn-sm btn-success" onclick="selesaiPesanan('${key}')">SELESAI</button></td>
        </tr>`;
      });
    }

    // kirimPesanan, addToCart, renderMenu, dll SAMA seperti kode sebelumnya

    // INIT
    showPage('menuPage');
    updateCartCount();
  </script>
</body>
</html>
